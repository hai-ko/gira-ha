# Token Authentication Guide for Gira X1 Integration

## Overview

The Gira X1 Home Assistant integration now supports two authentication methods:

1. **Username/Password Authentication** - Traditional login with credentials
2. **Token Authentication** - Use a pre-generated API token

## Why Use Token Authentication?

- **Security**: Avoid storing credentials in Home Assistant
- **Convenience**: Use tokens generated by other applications
- **Flexibility**: Easier integration with automation scripts and external systems

## How to Get a Gira X1 API Token

### Method 1: Using the Gira X1 Web Interface

1. Open your Gira X1 web interface in a browser
2. Navigate to **Settings > API Clients**
3. Create a new API client or use an existing one
4. Copy the generated token

### Method 2: Using REST API Directly

You can generate a token using a simple HTTP request:

```bash
curl -X POST https://YOUR_GIRA_X1_IP/api/v2/clients \
  -H "Content-Type: application/json" \
  -H "Authorization: Basic $(echo -n 'username:password' | base64)" \
  -d '{"client": "my_home_assistant"}' \
  -k
```

Replace:
- `YOUR_GIRA_X1_IP` with your device's IP address
- `username:password` with your actual credentials

The response will contain a `token` field that you can use.

### Method 3: Using Python Script

```python
import requests
import base64
import json

# Configuration
host = "192.168.1.100"
username = "your_username"
password = "your_password"
client_name = "home_assistant"

# Create authorization header
credentials = base64.b64encode(f"{username}:{password}".encode()).decode()
headers = {
    "Authorization": f"Basic {credentials}",
    "Content-Type": "application/json"
}

# Register client and get token
url = f"https://{host}/api/v2/clients"
data = {"client": client_name}

response = requests.post(url, headers=headers, json=data, verify=False)

if response.status_code == 201:
    token = response.json()["token"]
    print(f"Your API token: {token}")
else:
    print(f"Error: {response.status_code} - {response.text}")
```

## Configuration in Home Assistant

### Via UI (Recommended)

1. Go to **Settings > Devices & Services**
2. Click **Add Integration**
3. Search for "Gira X1"
4. Enter your device details:
   - **Host**: IP address of your Gira X1
   - **Port**: API port (usually 80)
   - **Authentication Method**: Select "Token"
5. Enter your API token
6. Click **Submit**

### Via YAML Configuration

Add to your `configuration.yaml`:

```yaml
gira_x1:
  host: "192.168.1.100"
  port: 80
  auth_method: "token"
  token: "your_api_token_here"
```

## Token Management

### Token Lifecycle

- Tokens generated through the API remain valid until explicitly deleted
- Tokens are tied to the client name used during creation
- Multiple tokens can exist for different clients

### Revoking Tokens

If you need to revoke a token:

```bash
curl -X DELETE https://YOUR_GIRA_X1_IP/api/v2/clients/YOUR_TOKEN -k
```

### Token Security

- **Store securely**: Treat tokens like passwords
- **Limit scope**: Use separate tokens for different applications
- **Rotate regularly**: Generate new tokens periodically
- **Monitor usage**: Check API logs for unauthorized access

## Troubleshooting

### "Invalid token" Error

- Verify the token is correct (no extra spaces or characters)
- Check if the token has been revoked
- Ensure the Gira X1 device is accessible

### Connection Issues

- Verify the host and port are correct
- Check network connectivity to the Gira X1 device
- Ensure the device's API is enabled

### Token Not Working

1. Test the token manually:
   ```bash
   curl -H "Authorization: Bearer YOUR_TOKEN" \
        https://YOUR_GIRA_X1_IP/api/v2/uiconfig -k
   ```

2. If manual test fails, regenerate the token

## Migration from Username/Password

To migrate an existing installation:

1. Generate a new API token using one of the methods above
2. Go to **Settings > Devices & Services**
3. Find your Gira X1 integration
4. Click **Configure**
5. Update the authentication method to "Token"
6. Enter your new token
7. Save the configuration

## Example Automation with Token

You can also use tokens in automations that call the Gira X1 API directly:

```yaml
automation:
  - alias: "Direct API Call with Token"
    trigger:
      - platform: time
        at: "08:00:00"
    action:
      - service: rest_command.gira_x1_api
        data:
          url: "https://192.168.1.100/api/v2/values"
          method: "POST"
          headers:
            Authorization: "Bearer YOUR_TOKEN"
            Content-Type: "application/json"
          payload: |
            {
              "12345": true
            }
```

This allows for direct API access while using the same token as the integration.
